<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>กราฟเชื่อมฐานข้อมูล</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>กราฟจากฐานข้อมูล</h2>

  <div>
    <button onclick="fetchAndUpdate('day')">วัน</button>
    <button onclick="fetchAndUpdate('week')">สัปดาห์</button>
    <button onclick="fetchAndUpdate('month')">เดือน</button>
    <button onclick="fetchAndUpdate('year')">ปี</button>
    <button onclick="downloadExcel()">ดาวน์โหลด Excel</button>
  </div>

  <canvas id="myChart" width="600" height="300"></canvas>

  <script>
    let allData = {}; // เก็บข้อมูลทั้งหมดทุกช่วงเวลา
    let currentPeriod = 'day';

    const ctx = document.getElementById('myChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
          label: 'ข้อมูล',
          data: [],
          backgroundColor: 'rgba(75, 192, 192, 0.6)'
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    function fetchAndUpdate(period) {
      currentPeriod = period;
      fetch('get_data.php?period=' + period)
        .then(response => response.json())
        .then(data => {
          const labels = data.map(row => row.label);
          const values = data.map(row => row.value);

          chart.data.labels = labels;
          chart.data.datasets[0].data = values;
          chart.update();

          allData[period] = { labels, values }; // เก็บไว้ใช้ตอน export Excel
        });
    }

    function downloadExcel() {
      const wb = XLSX.utils.book_new();

      for (const period in allData) {
        const sheetData = [['Label', 'Value']];
        const labels = allData[period].labels;
        const values = allData[period].values;

        for (let i = 0; i < labels.length; i++) {
          sheetData.push([labels[i], values[i]]);
        }

        const ws = XLSX.utils.aoa_to_sheet(sheetData);
        XLSX.utils.book_append_sheet(wb, ws, period);
      }

      XLSX.writeFile(wb, 'ข้อมูลจากระบบ.xlsx');
    }

    // โหลดเริ่มต้น
    fetchAndUpdate('day');
  </script>

</body>
</html>
